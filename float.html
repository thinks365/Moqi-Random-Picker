<!DOCTYPE html>
<html>
<head>
    <style>
    :root {
        --primary-color: #409eff;
        --bg-color: rgba(255, 255, 255, 0.95);
        --text-color: #333;
        --border-radius: 12px;
        --shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        --button-gradient: linear-gradient(135deg, var(--primary-color), #337ecc);
        --success-color: #67c23a;
        --warning-color: #e6a23c;
        /* 新增遮罩变量 */
        --edge-mask: linear-gradient(45deg, 
            transparent 12px, var(--bg-color) 12px,
            var(--bg-color) calc(100% - 12px), transparent calc(100% - 12px));
        
        /* 新增：动态样式变量 */
        --float-btn-bg-color: var(--primary-color);
        --float-btn-text-color: #ffffff;
        --float-name-color: var(--text-color);
        --float-name-shadow: none;
        --float-name-highlight-color: var(--primary-color);
        --float-btn-bg-opacity: 1;
        --float-btn-text-opacity: 1;
        --float-name-text-opacity: 1;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --bg-color: rgba(30, 30, 30, 0.95);
            --text-color: rgba(255, 255, 255, 0.9);
            --shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            --success-color: #85ce61;
            --warning-color: #ebb563;
        }
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-mask-image: -webkit-radial-gradient(white, black);
        mask-image: radial-gradient(white, black);
        user-select: none !important;
        cursor: default !important;
    }

    body {
        width: 160px;
        height: 80px;
        background: transparent!important;
        overflow: hidden;
        font-family: '微软雅黑', system-ui;
        position: relative;
    }

    /* 底层：白色背景层 */
    #float-container {
        width: calc(100% - 2px);
        height: calc(100% - 2px);
        position: absolute;
        top: 1px;
        left: 1px;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 16px;
        -webkit-app-region: drag;
        backdrop-filter: blur(10px);
        background: var(--edge-mask);
        border-radius: var(--border-radius);
        isolation: isolate;
        z-index: 99;
    }

    /* 添加阴影层 */
    #float-container::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        z-index: -1;
        pointer-events: none;
    }

    /* 扩展模糊层 */
    #float-container::before {
        content: '';
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        background: var(--bg-color);
        border-radius: calc(var(--border-radius) + 10px);
        z-index: -2;
        backdrop-filter: blur(20px);
    }

    /* 中间层：背景图片容器 */
    #background-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 999;
        border-radius: var(--border-radius);
        overflow: hidden;
        pointer-events: none;
    }

    #background-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 1;
        border-radius: var(--border-radius);
        pointer-events: none;
    }

    /* 最高层：状态指示器 */
    .status-indicator {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 6px;
        z-index: 9999;
        pointer-events: none;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #ddd;
        transition: all 0.3s;
        transform: translateZ(0);
    }

    .status-dot.active {
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    /* 最高层：内容区域 */
    #content-wrapper {
        flex: 1;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 9999;
        pointer-events: none;
    }

    /* 最高层：姓名显示 */
    #float-name {
    font-size: 18px;
    font-weight: 600;
    color: rgba(var(--float-name-color-rgb), var(--float-name-text-opacity));
    max-width: 100%;
    text-align: center;
    user-select: none;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    position: relative;
    z-index: 9999;
    pointer-events: none;
    text-shadow: var(--float-name-shadow);
    transition: color 0.5s ease;
    }

    /* 按钮容器 */
   .button-container {
        display: flex;
        align-items: stretch;
        margin-top: 8px;
        width: 100%;
        height: 28px;
        -webkit-app-region: no-drag;
        /* gap: 2px; 添加微小间隙 */
    }

    /* 快速点名按钮 - 左侧圆角，右侧直角 */
    .quick-roll-btn {
        flex: 1;
        padding: 6px 12px;
        font-size: 12px;
        background: linear-gradient(135deg, 
            rgba(var(--float-btn-bg-color-rgb), var(--float-btn-bg-opacity)), 
            rgba(var(--float-btn-bg-color-rgb), var(--float-btn-bg-opacity)));
        border: none;
        color: rgba(var(--float-btn-text-color-rgb), var(--float-btn-text-opacity));
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: transform 0.2s, box-shadow 0.2s;
        /* 左侧圆角，右侧直角 */
        border-radius: 20px 0 0 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        justify-content: center;
        /* 确保按钮内容不超出 */
        overflow: hidden;
    }

    /* 菜单按钮 - 左侧直角，右侧圆角 */
    .menu-btn {
        padding: 6px 8px;
        font-size: 12px;
        background: linear-gradient(135deg, 
            rgba(var(--float-btn-bg-color-rgb), var(--float-btn-bg-opacity)), 
            rgba(var(--float-btn-bg-color-rgb), var(--float-btn-bg-opacity)));
        border: none;
        color: rgba(var(--float-btn-text-color-rgb), var(--float-btn-text-opacity));
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s, box-shadow 0.2s;
        /* 左侧直角，右侧圆角 */
        border-radius: 0 20px 20px 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        width: 32px;
        min-width: 32px;
    }

    /* 悬停效果*/
    .quick-roll-btn:hover, .menu-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* 按钮图标 */
    .button-icon {
        width: 14px;
        height: 14px;
        fill: var(--float-btn-text-color);
    }

    /* 菜单按钮的图标稍微小一点 */
    .menu-btn .button-icon {
        width: 10px;
        height: 10px;
    }
</style>

</head>
<body>
    <!-- 底层：白色背景层 -->
    <div id="float-container">
        <div class="status-indicator">
            <div class="status-dot" id="status-led"></div>
        </div>

        <!-- 中间层：背景图片容器 -->
        <div id="background-container">
            <img id="background-image" alt="悬浮窗背景">
        </div>

        <div id="content-wrapper">
            <div id="float-name">准备就绪</div>
        </div>
        
        <!-- 修改按钮容器 -->
        <div class="button-container">
            <button id="quick-roll-btn" class="quick-roll-btn">
                <svg class="button-icon" viewBox="0 0 24 24">
                    <path d="M13.5 2.5c0-.828.672-1.5 1.5-1.5s1.5.672 1.5 1.5v5.078l3.891-3.184a1.5 1.5 0 012.328 1.25v9.912a1.5 1.5 0 01-2.328 1.25L16.5 13.422v5.078c0 .828-.672 1.5-1.5 1.5s-1.5-.672-1.5-1.5V2.5zM8 4a4 4 0 00-4 4v8a4 4 0 008 0V8a4 4 0 00-4-4z"/>
                </svg>
                快速点名
            </button>
            <button id="menu-btn" class="menu-btn">
                <svg class="button-icon" viewBox="0 0 24 24">
                    <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
            </button>
        </div>
    </div>
    
    <script>
        const { ipcRenderer } = require('electron');
        const floatName = document.getElementById('float-name');
        const statusLed = document.getElementById('status-led');
        const backgroundImage = document.getElementById('background-image');
        const quickRollBtn = document.getElementById('quick-roll-btn');
        const menuBtn = document.getElementById('menu-btn');

        // 加载保存的背景图片
        function loadBackgroundImage() {
            const savedBg = localStorage.getItem('floatBackground');
            if (savedBg) {
                backgroundImage.src = savedBg;
                backgroundImage.style.display = 'block';
            } else {
                backgroundImage.style.display = 'none';
            }
        }

        // 加载保存的悬浮窗样式
        function loadFloatStyles() {
            const savedStyles = localStorage.getItem('floatStyles');
            if (savedStyles) {
                const styles = JSON.parse(savedStyles);
                applyFloatStyleChanges(styles);
            }
        }

        // 应用悬浮窗样式更改
        function applyFloatStyleChanges(styles) {
            document.documentElement.style.setProperty('--float-btn-bg-color', styles.btnBgColor);
            document.documentElement.style.setProperty('--float-btn-text-color', styles.btnTextColor);
            document.documentElement.style.setProperty('--float-name-color', styles.nameColor);
            document.documentElement.style.setProperty('--float-name-highlight-color', styles.nameHighlightColor || styles.btnBgColor);
            
            const btnBgRgb = hexToRgb(styles.btnBgColor);
            const btnTextRgb = hexToRgb(styles.btnTextColor);
            const nameColorRgb = hexToRgb(styles.nameColor);
            
            if (btnBgRgb) {
                document.documentElement.style.setProperty('--float-btn-bg-color-rgb', `${btnBgRgb.r}, ${btnBgRgb.g}, ${btnBgRgb.b}`);
            }
            if (btnTextRgb) {
                document.documentElement.style.setProperty('--float-btn-text-color-rgb', `${btnTextRgb.r}, ${btnTextRgb.g}, ${btnTextRgb.b}`);
            }
            if (nameColorRgb) {
                document.documentElement.style.setProperty('--float-name-color-rgb', `${nameColorRgb.r}, ${nameColorRgb.g}, ${nameColorRgb.b}`);
            }
            
            document.documentElement.style.setProperty('--float-btn-bg-opacity', (styles.btnBgOpacity / 100).toString());
            document.documentElement.style.setProperty('--float-btn-text-opacity', (styles.btnTextOpacity / 100).toString());
            document.documentElement.style.setProperty('--float-name-text-opacity', (styles.nameTextOpacity / 100).toString());
            
            if (styles.nameShadow) {
                const shadowColor = styles.nameShadowColor || '#000000';
                document.documentElement.style.setProperty('--float-name-shadow', `0 1px 3px ${shadowColor}`);
            } else {
                document.documentElement.style.setProperty('--float-name-shadow', 'none');
            }
            
            localStorage.setItem('floatStyles', JSON.stringify(styles));
        }

        // 初始化时加载背景和样式
        loadBackgroundImage();
        loadFloatStyles();

        // 监听背景更新
        ipcRenderer.on('update-float-background', (_, imageData) => {
            if (imageData) {
                localStorage.setItem('floatBackground', imageData);
                backgroundImage.src = imageData;
                backgroundImage.style.display = 'block';
            } else {
                localStorage.removeItem('floatBackground');
                backgroundImage.style.display = 'none';
            }
        });

        // 监听样式更新
        ipcRenderer.on('update-float-styles', (_, styles) => {
            applyFloatStyleChanges(styles);
        });

        ipcRenderer.on('update-name', (_, name) => {
            if (name === '点名中') {
                statusLed.classList.add('active');
                statusLed.style.backgroundColor = 'var(--warning-color)';
            } else {
                statusLed.classList.remove('active');
                statusLed.style.backgroundColor = 'var(--success-color)';
                setTimeout(() => {
                    statusLed.style.backgroundColor = '#ddd';
                }, 1000);
            }
            floatName.textContent = name;
            floatName.style.color = '';
        });

        function requestQuickRoll() {
            ipcRenderer.send('quick-roll');
        }

        // 初始化状态指示灯
        statusLed.style.backgroundColor = '#ddd';
        let animationNames = [];
        let animationInterval = null;
        ipcRenderer.on('start-float-animation', (_, { names, speed }) => {
          animationNames = names;
          animateNames(speed);
        });
        ipcRenderer.on('stop-float-animation', (_, name) => {
          stopAnimation(name);
        });
        
        function animateNames(speed) {
          if (animationInterval) clearInterval(animationInterval);
          
          floatName.style.opacity = '0.5';
          floatName.style.transform = 'scale(0.9)';
          
          animationInterval = setInterval(() => {
            const index = Math.floor(Math.random() * animationNames.length);
            floatName.textContent = animationNames[index];
            
            floatName.style.opacity = '1';
            floatName.style.transform = 'scale(1.05)';
            setTimeout(() => {
              floatName.style.transform = 'scale(1)';
            }, 100);
          }, speed);
          statusLed.style.backgroundColor = 'var(--warning-color)';
          statusLed.style.animation = 'pulse 1s infinite';
        }
        
        function stopAnimation(finalName) {
          if (animationInterval) clearInterval(animationInterval);
          
          floatName.textContent = finalName;
          floatName.style.color = 'var(--float-name-highlight-color)';
          floatName.style.transform = 'scale(1.2)';
          setTimeout(() => {
            floatName.style.transform = 'scale(1)';
            floatName.style.color = 'var(--float-name-color)';
          }, 500);
          statusLed.style.animation = '';
          statusLed.style.backgroundColor = 'var(--success-color)';
          setTimeout(() => {
            statusLed.style.backgroundColor = '#ddd';
          }, 1000);
        }

        // 十六进制颜色转RGB函数
        function hexToRgb(hex) {
            hex = hex.replace(/^#/, '');
            
            if (hex.length === 3) {
                hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
            }
            
            const result = /^([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            if (!result) return null;
            
            return {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            };
        }

        // 按钮事件监听
        quickRollBtn.addEventListener('click', requestQuickRoll);
        
        // 菜单按钮点击事件 - 请求显示系统菜单
        menuBtn.addEventListener('click', () => {
            ipcRenderer.send('show-float-menu');
        });
    </script>
</body>
</html>